import cohere

co = cohere.Client(os.getenv("COHERE_API_KEY"))  # ë˜ëŠ” ì§ì ‘ í‚¤ ì…ë ¥

query = "ë§ê³  ì¬ë°°ë°©ë²•ì„ ì•Œë ¤ì¤˜"
retrieved_docs = mango_vectorstore.as_retriever(search_kwargs={"k": 10}).invoke(query)

# ë¬¸ì„œ í…ìŠ¤íŠ¸ ë¦¬ìŠ¤íŠ¸ ìƒì„±
docs_texts = [doc.page_content for doc in retrieved_docs]

# Cohere Rerank API í˜¸ì¶œ
response = co.rerank(
    model="rerank-multilingual-v3.0",
    query=query,
    documents=docs_texts,
    top_n=5,
)

# ì¶œë ¥
print("\nğŸ“Œ [Cohere ì§ì ‘ í˜¸ì¶œí•œ Reranker ê²°ê³¼ Top 5]")
for i, r in enumerate(response.results):
    doc = retrieved_docs[r.index]  # ì›ë˜ ë¬¸ì„œì™€ ë§¤í•‘
    print(f"\n[{i+1}ìœ„] ì ìˆ˜: {r.relevance_score}")
    print(f"ë¬¸ì„œ ì¶œì²˜: {doc.metadata.get('ì¶œì²˜')}, í˜ì´ì§€: {doc.metadata.get('í˜ì´ì§€')}")
    print(doc.page_content[:500])
    print("-" * 80)

# csv ì €ì¥
import pandas as pd

data = []
for i, r in enumerate(response.results):
    doc = retrieved_docs[r.index]
    data.append({
        "ë­í‚¹": i+1,
        "ì ìˆ˜": r.relevance_score,
        "ì¶œì²˜": doc.metadata.get("ì¶œì²˜"),
        "í˜ì´ì§€": doc.metadata.get("í˜ì´ì§€"),
        "ë‚´ìš©ìš”ì•½": doc.page_content[:300]
    })

df = pd.DataFrame(data)
df.to_csv("reranker_eval_result.csv", index=False)
print("âœ… í‰ê°€ ê²°ê³¼ê°€ CSVë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.")
